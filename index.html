<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¿¡ç”¨å¡èŠ±è²» Data Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">

  <header class="text-center mb-4">
    <h1 class="text-2xl font-bold mb-1">ğŸ’³ ä¿¡ç”¨å¡èŠ±è²» Data Board</h1>
    <p class="text-gray-600 text-sm">è³‡æ–™ä¾†æºï¼šdata.csv</p>
  </header>

  <!-- åˆ†æå€ï¼ˆç§»åˆ°æœ€ä¸Šæ–¹ï¼‰ -->
  <div id="analysisBox" class="w-full max-w-4xl bg-white shadow rounded-lg p-4 mb-8">
    <h2 class="font-semibold mb-2 text-center">ğŸ” ä»Šå¹´æ¶ˆè²»åˆ†æ</h2>
    <div id="analysisContent" class="space-y-2 text-gray-800 text-base"></div>
  </div>

  <!-- æç¤ºå€ -->
  <div id="alertBox" class="hidden w-full max-w-md bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 rounded">
    <p id="alertText" class="text-center font-medium"></p>
  </div>

  <!-- åœ–è¡¨å®¹å™¨ -->
  <div class="w-full max-w-4xl space-y-8">
    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="font-semibold mb-2 text-center">ğŸ“ˆ æ¯æœˆå„å¡æ¶ˆè²» (é•·æ¢åœ–)</h2>
      <canvas id="barChart"></canvas>
    </div>

    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="font-semibold mb-2 text-center">ğŸ“Š æ¯æœˆç¸½èŠ±è²» (æŠ˜ç·šåœ–)</h2>
      <canvas id="lineChart"></canvas>
    </div>

    <div class="bg-white shadow rounded-lg p-4">
      <h2 class="font-semibold mb-2 text-center">ğŸ§© å„å¡å æ¯” (åœ“é¤…åœ–)</h2>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <script>
    let data = [];

    const alertBox = document.getElementById("alertBox");
    const alertText = document.getElementById("alertText");

    const barCtx = document.getElementById("barChart").getContext("2d");
    const lineCtx = document.getElementById("lineChart").getContext("2d");
    const pieCtx = document.getElementById("pieChart").getContext("2d");

    let barChart, lineChart, pieChart;

    function parseValue(v) {
      return Number(String(v).replace(/[$,]/g, "")) || 0;
    }

    function drawCharts() {
      if (!data || data.length === 0) return;

      const months = data.map(d => d.Month);
      const cards = Object.keys(data[0]).filter(k => !["Year", "Month", "Moth_text", "Total"].includes(k));

      const datasets = cards.map((card, i) => ({
        label: card,
        data: data.map(d => parseValue(d[card])),
        backgroundColor: `hsl(${i * 60}, 70%, 60%)`
      }));

      // é•·æ¢åœ–
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: "bar",
        data: { labels: months, datasets },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // æŠ˜ç·šåœ–
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(lineCtx, {
        type: "line",
        data: {
          labels: months,
          datasets: [{
            label: "ç¸½èŠ±è²»",
            data: data.map(d => parseValue(d.Total)),
            borderColor: "#2563eb",
            fill: false,
            tension: 0.2
          }]
        },
        options: { responsive: true }
      });

      // åœ“é¤…åœ– (æœ€å¾Œä¸€å€‹æœ‰æ¶ˆè²»çš„æœˆä»½)
      let latest = null;
      for (let i = data.length - 1; i >= 0; i--) {
        if (parseValue(data[i].Total) > 0) {
          latest = data[i];
          break;
        }
      }
      const pieData = cards.map(c => parseValue(latest ? latest[c] : 0));
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: cards,
          datasets: [{
            data: pieData,
            backgroundColor: cards.map((c, i) => `hsl(${i * 60}, 70%, 60%)`)
          }]
        },
        options: { responsive: true }
      });

      // åœ‹æ³°1015å¹³å‡æç¤º
      const targetCard = "åœ‹æ³°1015";
      const values = data.map(d => parseValue(d[targetCard])).filter(v => v > 0);
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const current = parseValue(latest[targetCard]);

      if (current > avg) {
        alertBox.classList.remove("hidden");
        alertBox.classList.add("bg-red-100", "border-red-500", "text-red-700");
        alertText.textContent = `âš ï¸ åœ‹æ³°1015 (${current.toLocaleString()}) å·²è¶…éä»Šå¹´å¹³å‡ (${avg.toFixed(0).toLocaleString()})`;
      } else {
        alertBox.classList.remove("hidden");
        alertBox.classList.remove("bg-red-100", "border-red-500", "text-red-700");
        alertText.textContent = `âœ… åœ‹æ³°1015 (${current.toLocaleString()}) å°šæœªè¶…éå¹³å‡ (${avg.toFixed(0).toLocaleString()})`;
      }

      renderAnalysis();
    }

    function renderAnalysis() {
      const analysisContent = document.getElementById("analysisContent");
      if (!data || data.length === 0) {
        analysisContent.innerHTML = "";
        return;
      }
      const cards = Object.keys(data[0]).filter(k => !["Year", "Month", "Moth_text", "Total"].includes(k));
      // å„å¡ç´¯ç©æ¶ˆè²»
      const cardTotals = cards.map(card => ({
        card,
        total: data.reduce((sum, d) => sum + parseValue(d[card]), 0)
      }));
      // ä»Šå¹´ç¸½æ¶ˆè²»
      const totalSum = data.reduce((sum, d) => sum + parseValue(d.Total), 0);
      // æ¶ˆè²»æœ€å¤šçš„æœˆä»½
      const maxMonth = data.reduce((max, d) => parseValue(d.Total) > max.val ? {val: parseValue(d.Total), month: d.Month} : max, {val: 0, month: ''});
      // å„å¡æ¶ˆè²»æœ€é«˜çš„æœˆä»½
      const cardMaxMonths = cards.map(card => {
        let max = {val: 0, month: ''};
        data.forEach(d => {
          const v = parseValue(d[card]);
          if (v > max.val) max = {val: v, month: d.Month};
        });
        return {card, ...max};
      });
      let html = '';
      html += `<div>ä»Šå¹´ç¸½æ¶ˆè²»é‡‘é¡ï¼š<span class='font-bold text-blue-700'>${totalSum.toLocaleString()}</span> å…ƒ</div>`;
      html += `<div>æ¶ˆè²»æœ€å¤šçš„æœˆä»½ï¼š<span class='font-bold text-red-700'>${maxMonth.month}</span>ï¼Œé‡‘é¡ <span class='font-bold'>${maxMonth.val.toLocaleString()}</span> å…ƒ</div>`;
      html += `<div>å„å¡ç´¯ç©æ¶ˆè²»ï¼š</div><ul class='list-disc pl-6'>`;
      cardTotals.forEach(c => {
        html += `<li>${c.card}ï¼š<span class='font-bold'>${c.total.toLocaleString()}</span> å…ƒ</li>`;
      });
      html += `</ul>`;
      html += `<div>å„å¡æ¶ˆè²»æœ€é«˜æœˆä»½ï¼š</div><ul class='list-disc pl-6'>`;
      cardMaxMonths.forEach(c => {
        html += `<li>${c.card}ï¼š<span class='font-bold text-red-700'>${c.month}</span>ï¼Œé‡‘é¡ <span class='font-bold'>${c.val.toLocaleString()}</span> å…ƒ</li>`;
      });
      html += `</ul>`;
      analysisContent.innerHTML = html;
    }

    // ç›´æ¥è®€å– data.csv ä¸¦è§£æ
    fetch('data.csv')
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            // åªä¿ç•™å·²éå»çš„æœˆä»½
            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2, '0')}`;
            data = results.data.filter(d => {
              // Month æ ¼å¼å¦‚ 2025/11
              return d.Month && d.Month <= currentYearMonth;
            });
            drawCharts();
          }
        });
      });
  </script>
</body>
</html>
